#!/bin/bash

# Etapa 20: Buscar Exploits Públicos
# Script para executar searchsploit via Docker usando imagem base e instalando Exploit-DB

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$BASE_DIR"

echo "=========================================="
echo "ETAPA 20: BUSCAR EXPLOITS PÚBLICOS (DOCKER)"
echo "=========================================="
echo ""

# Verificar se Docker está instalado
if ! command -v docker &> /dev/null; then
    echo "[!] Docker não encontrado. Instale o Docker Desktop para Windows:"
    echo "    https://www.docker.com/products/docker-desktop"
    exit 1
fi

# Verificar se Docker está rodando
if ! docker info &> /dev/null; then
    echo "[!] Docker não está rodando. Inicie o Docker Desktop."
    exit 1
fi

echo "[+] Docker encontrado e rodando"
echo ""

# Função para executar searchsploit via Docker
run_searchsploit() {
    local search_term="$1"
    local output_file="$2"
    
    echo "[*] Buscando: $search_term"
    docker run --rm \
        -v /c/Sec/Pentests/DesarrolloEmpleo-ar/reports/etapa20_exploits_publicos:/output \
        ubuntu:22.04 bash -c "
        apt-get update -qq > /dev/null 2>&1 && \
        apt-get install -y -qq git > /dev/null 2>&1 && \
        cd /tmp && \
        git clone https://github.com/offensive-security/exploitdb.git > /dev/null 2>&1 && \
        cd exploitdb && \
        ./searchsploit $search_term 2>&1
    " > "$output_file" 2>&1
    
    if [ -s "$output_file" ]; then
        cat "$output_file"
    else
        echo "  (Nenhum resultado encontrado)"
    fi
}

echo "[+] Teste 1: searchsploit - WordPress Core 6.8.3"
echo "--------------------------------------------"
run_searchsploit "wordpress 6.8" "searchsploit_wordpress.txt"
echo ""

echo "[+] Teste 2: searchsploit - Elementor"
echo "--------------------------------------------"
run_searchsploit "elementor" "searchsploit_elementor.txt"
echo ""

echo "[+] Teste 3: searchsploit - Elementor Pro"
echo "--------------------------------------------"
run_searchsploit "elementor pro" "searchsploit_elementor_pro.txt"
echo ""

echo "[+] Teste 4: searchsploit - Plugins WordPress"
echo "--------------------------------------------"
run_searchsploit "ivory search" "searchsploit_ivory_search.txt"
run_searchsploit "spotlight social" "searchsploit_spotlight.txt"
echo ""

echo "[+] Teste 5: searchsploit - Astra Theme"
echo "--------------------------------------------"
run_searchsploit "astra" "searchsploit_astra.txt"
echo ""

echo "[+] Teste 6: searchsploit - jQuery Migrate"
echo "--------------------------------------------"
run_searchsploit "jquery migrate" "searchsploit_jquery_migrate.txt"
echo ""

echo "[+] Teste 7: searchsploit - Addons for Elementor"
echo "--------------------------------------------"
run_searchsploit "addons for elementor" "searchsploit_addons_elementor.txt"
echo ""

echo "=========================================="
echo "TESTES CONCLUÍDOS"
echo "=========================================="
echo "Resultados salvos em: $BASE_DIR"
echo ""
echo "Arquivos gerados:"
ls -lh searchsploit_*.txt 2>/dev/null | awk '{print "  - " $9 " (" $5 ")"}'
