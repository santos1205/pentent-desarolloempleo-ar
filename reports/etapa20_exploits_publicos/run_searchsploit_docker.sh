#!/bin/bash

# Etapa 20: Buscar Exploits Públicos
# Script para executar searchsploit via Docker em todos os componentes identificados

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$BASE_DIR"

echo "=========================================="
echo "ETAPA 20: BUSCAR EXPLOITS PÚBLICOS (DOCKER)"
echo "=========================================="
echo ""

# Verificar se Docker está instalado
if ! command -v docker &> /dev/null; then
    echo "[!] Docker não encontrado. Instale o Docker Desktop para Windows:"
    echo "    https://www.docker.com/products/docker-desktop"
    exit 1
fi

# Verificar se Docker está rodando
if ! docker info &> /dev/null; then
    echo "[!] Docker não está rodando. Inicie o Docker Desktop."
    exit 1
fi

echo "[+] Docker encontrado e rodando"
echo ""

# Usar imagem do Exploit-DB via Docker
DOCKER_IMAGE="reedcrif/searchsploit:latest"

# Verificar se a imagem existe, se não, fazer pull
if ! docker image inspect "$DOCKER_IMAGE" &> /dev/null; then
    echo "[+] Baixando imagem do Exploit-DB..."
    docker pull "$DOCKER_IMAGE"
fi

echo "[+] Teste 1: searchsploit - WordPress Core 6.8.3"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit wordpress 6.8 | tee searchsploit_wordpress.txt
echo ""

echo "[+] Teste 2: searchsploit - Elementor"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit elementor | tee searchsploit_elementor.txt
echo ""

echo "[+] Teste 3: searchsploit - Elementor Pro"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit "elementor pro" | tee searchsploit_elementor_pro.txt
echo ""

echo "[+] Teste 4: searchsploit - Plugins WordPress"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit "ivory search" | tee searchsploit_ivory_search.txt
docker run --rm "$DOCKER_IMAGE" searchsploit "spotlight social" | tee searchsploit_spotlight.txt
echo ""

echo "[+] Teste 5: searchsploit - Astra Theme"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit astra | tee searchsploit_astra.txt
echo ""

echo "[+] Teste 6: searchsploit - jQuery Migrate"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit "jquery migrate" | tee searchsploit_jquery_migrate.txt
echo ""

echo "[+] Teste 7: searchsploit - Addons for Elementor"
echo "--------------------------------------------"
docker run --rm "$DOCKER_IMAGE" searchsploit "addons for elementor" | tee searchsploit_addons_elementor.txt
echo ""

echo "=========================================="
echo "TESTES CONCLUÍDOS"
echo "=========================================="
echo "Resultados salvos em: $BASE_DIR"
echo ""
echo "Arquivos gerados:"
ls -lh searchsploit_*.txt 2>/dev/null | awk '{print "  - " $9 " (" $5 ")"}'
